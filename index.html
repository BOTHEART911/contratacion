<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>CONTRATACI√ìN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1763928947/Logo_lt365u.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
  :root{
    --primary:#06402B;
    --primary-2:#04281C;
    --ok:#16a34a;
    --error:#dc2626;
    --scrim:rgba(0,0,0,.35);
  }
  html,body{
    margin:0; padding:0; height:100%; width:100%;
    overflow-x:hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:#111;
    background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905869/fondo_rosa_n775m4.png') center/cover fixed no-repeat;
  }
  .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

  .view{ display:none; opacity:0; transform: translateY(8px);
    transition: opacity .25s ease, transform .25s ease;
    box-sizing:border-box; padding:16px;
  }
  .view.active{ display:block; opacity:1; transform: translateY(0); }

  .card{
    background: rgba(255,255,255,.06); /* transparencia tipo portal */
    backdrop-filter: blur(3px);
    border: 2px solid #ddd;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0,0,0,.18);
    max-width: 820px;
    margin: 16px auto;
    padding: 20px 20px 16px;
  }
  h1,h2,h3{ margin: 8px 0 12px; text-align:center; }
  p.helper{ color:#444; font-size:.95rem; text-align:center; margin:8px 0 16px; }
  label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
  input, select, textarea, button{
    width:100%; padding:12px; box-sizing:border-box;
    border:1.5px solid #ccc; border-radius:8px; background:#fff;
    outline:none; transition: border-color .2s ease, transform .08s ease;
    font-size:16px;
  }
  input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
  button{
    cursor:pointer; border:2px solid var(--primary);
    background:#fff; color:#000; font-weight:700;
  }
  button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
  .btn-primary{ background:var(--primary); color:#fff; }
  .btn-row{ display:flex; gap:12px; flex-wrap:wrap; }
  .btn-row > *{ flex:1; }
  .muted{ color:#666; font-size:.85rem; }
  .center{ text-align:center; }
  .image-center{ display:flex; justify-content:center; }
  .brand{ width:240px; border-radius:12px; display:block; margin:12px auto 4px; }
  .banner-bottom{ width:240px; border-radius:12px; display:block; margin:16px auto 8px; }
  .chip{
    padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
    background:#fff; font-weight:700; color:#000; text-decoration:none;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
  }
  .danger{ background:#e11; border-color:#e11; color:#fff; }

  /* Botones de icono: sin recuadro ni fondo */
  .btn-icon{
    background: transparent !important;
    border: 0 !important;
    box-shadow: none !important;
    padding: 10px !important;
    display: flex;                 /* centra el icono */
    align-items: center;
    justify-content: center;
  }
  .btn-icon:hover,
  .btn-icon:active{
    background: transparent !important;
    color: inherit !important;
    border: 0 !important;
  }
  .btn-icon:focus-visible{
    outline: none;
    box-shadow: 0 0 0 3px rgba(4,40,28,.28); /* anillo de enfoque accesible */
    border-radius: 10px;
  }
  .btn-icon img{
    width: 80px; height: 80px; display: block; /* Tama√±o de Iconos */
    border: 0; border-radius: 0; background: transparent;
    pointer-events: none;
  }

  /* Loader centrado */
  .loader{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
    z-index:9999; backdrop-filter: blur(2px);
    opacity:1; transition: opacity .12s ease;
    will-change: opacity;
  }
  .loader.hidden{
    opacity:0; pointer-events:none;
  }

  .spinner-ios{
    position:relative; width:64px; height:64px;
  }
  .spinner-ios i{
    position:absolute; left:50%; top:50%;
    width:6px; height:18px; margin:-9px 0 0 -3px;
    background:#fff; border-radius:3px;
    opacity:.2;
    animation:iosFade 1.2s linear infinite;
    transform-origin: center center;
  }
  @keyframes iosFade{
    0%, 39%, 100% { opacity:.2; }
    40% { opacity:1; }
  }
  .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
  .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
  .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
  .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
  .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
  .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
  .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
  .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
  .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
  .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
  .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
  .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

  .hidden{ display:none !important; }

  .narrow{ max-width: 560px; margin: 0 auto; }
  .spaced{ margin-top:12px; }

  /* Listados reutilizables */
  .list-grid{
    display:flex; flex-direction:column; gap:14px;
    margin-top:14px;
  }
  .item-card{
    background: rgba(255,255,255,.06); /* mismo efecto glass */
    backdrop-filter: blur(3px);
    border: 2px solid #ddd;
    border-radius:16px;
    padding:14px 16px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  /* Fila de acciones en cada contratista */
  .contr-actions .right-group .btn-icon{
    /* Integraci√≥n unificada para evitar conflicto entre reglas duplicadas */
    flex:0 0 auto;
    width:auto;
    display:inline-flex !important;
    align-items:center;
    justify-content:center;

    padding:6px !important;              /* tama√±o compacto (ajusta a 10px si deseas m√°s √°rea) */
    border:0 !important;
    background:transparent !important;
    box-shadow:none !important;
    cursor:pointer;
    transition:transform .12s ease;
  }
  .contr-actions .right-group .btn-icon:hover{
    transform:scale(1.08);
  }
  .contr-actions .right-group .btn-icon:active{
    transform:scale(.94);
  }
  .contr-actions .right-group .btn-icon img{
    width:44px !important;
    height:44px !important;
    display:block;
    object-fit:contain;
    pointer-events:none;
    /* Si quieres quitar la ligera sombra, elimina la l√≠nea siguiente */
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));
  }
  @media (max-width:700px){
    /* En m√≥viles puedes reducir un poco si lo deseas */
    .contr-actions .right-group .btn-icon img{
      width:40px !important;
      height:40px !important;
    }
  }
    
  .item-header{
    display:flex; flex-wrap:wrap;
    gap:8px; align-items:center; justify-content:space-between;
  }
  .item-title{
    font-weight:900; font-size:1rem; color:var(--primary); margin:0;
  }
  .item-sub{
    font-size:.72rem; font-weight:700; color:#333; margin:0;
  }

  .tag-count{
    display:inline-block;
    border-radius:999px;
    padding:8px 16px;
    font-weight:900; text-align:center;
    color:#06402B; background:#d7f8e3;
    border:3px solid #7adf9b;
    box-shadow:0 4px 10px rgba(0,0,0,.12);
    min-width:120px;
  }
  .filter-input{
    appearance:none;
    border-radius:999px;
    background:#fff;
    border:3px solid #06402B;
    padding:12px 16px;
    font-weight:700;
    min-width:240px;
    max-width:420px;
    box-shadow:0 8px 18px rgba(0,0,0,.08);
    outline:none;
    font-size:.95rem;
  }
  .filter-input::placeholder{ color:#999; font-weight:600; }

  .estado-badge{
    display:inline-block;
    border-radius:999px;
    padding:6px 14px;
    font-weight:800;
    background:#c6f6d5;
    color:#06402B;
    border:2px solid #16a34a;
    font-size:.72rem;
  }
  .estado-badge.inactivo{
    background:#fee2e2;
    color:#991b1b;
    border-color:#dc2626;
  }

  /* Secciones expandibles en revisi√≥n */
  .section-toggle{ margin:12px 0; }
  .section-content{
    margin:8px 0 18px;
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(3px);
    border:2px solid #ddd;
    border-radius:14px;
    padding:14px;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
  }
  .section-content.hidden{ display:none; }

  .oblig-block{
    background:#f8f8f8;
    border:1.5px solid #ccc;
    border-radius:12px;
    padding:10px 12px;
    margin:10px 0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .oblig-title{
    font-weight:800;
    margin:0;
    color:var(--primary);
    font-size:.9rem;
  }
  .oblig-sub{
    margin:0;
    font-size:.75rem;
    color:#333;
    font-weight:600;
  }

  .evidence-grid{
    display:flex; flex-wrap:wrap; gap:10px;
    justify-content:center; /* centrado */
  }
  .evidence-thumb{
    width:100%; max-width:320px;
    aspect-ratio:4/3;
    object-fit:cover;
    border-radius:10px;
    border:2px solid #ddd;
    background:#eee;
    cursor:zoom-in;
    display:block;
    margin:0 auto;
  }

  /* Modal Requerimiento */
  .modal-backdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    display:flex; align-items:center; justify-content:center;
    z-index:9998; padding:20px;
  }
  .modal{
    background:#fff; border-radius:16px;
    max-width:520px; width:100%;
    padding:20px 20px 14px;
    box-shadow:0 8px 22px rgba(0,0,0,.25);
    animation:modalIn .25s ease;
  }
  @keyframes modalIn{
    from{ opacity:0; transform:translateY(12px); }
    to{ opacity:1; transform:translateY(0); }
  }

  @media (max-width: 700px){
    .btn-row{ flex-direction:column; }
    .item-header{ flex-direction:column; align-items:flex-start; }
  }

  /* === Toggle mostrar/ocultar c√©dula (login) === */
  .pwd-wrapper{
    position:relative;
    width:100%;
  }
  .pwd-wrapper input#login-cedula{
    display:block;
    width:100%;
    box-sizing:border-box;
    padding-right:40px;          /* reduce un poco el campo para el icono */
  }
  .toggle-cedula{
    position:absolute;
    top:50%;
    right:10px;                  /* bien a la derecha */
    transform:translateY(-50%);
    background:transparent !important;
    border:0 !important;
    padding:0;
    width:28px;                  /* bot√≥n peque√±o */
    height:28px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    border-radius:6px;
  }
  .toggle-cedula:hover{
    background:rgba(0,0,0,.06);
  }
  .toggle-cedula:active{
    transform:translateY(-50%) scale(.92);
  }
  .toggle-cedula:focus-visible{
    outline:none;
    box-shadow:0 0 0 3px rgba(6,64,43,.35);
  }
  .toggle-cedula img{
    width:22px;                  /* icono peque√±o */
    height:22px;
    display:block;
    pointer-events:none;         /* que el click siempre sea del bot√≥n */
  }

  @media (max-width:480px){
    .pwd-wrapper input#login-cedula{ padding-right:36px; }
    .toggle-cedula{ right:8px; width:26px; height:26px; }
    .toggle-cedula img{ width:20px; height:20px; }
  }

  /* === Alinear √≠conos WhatsApp y Drive en UNA MISMA L√çNEA dentro de cada contratista === */
  .contr-actions{
    display:flex;
    flex-wrap:nowrap;              /* evita que el grupo de iconos salte a otra l√≠nea */
  }
  .contr-actions .left-group{
    display:flex;
    gap:12px;
    flex:1 1 auto;                 /* botones grandes ocupan el espacio principal */
  }
  .contr-actions .right-group{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:12px;
    margin-left:12px;              /* peque√±o espacio respecto a los botones de la izquierda */
    flex:0 0 auto;
    min-width:auto;
  }

  /* Bot√≥n "CUENTA" en vista Revisar (estilo como Drive en Contratistas) */
  #btn-abrir-carpeta-cuenta.btn-icon{
    padding:6px !important;
    background:transparent !important;
    border:0 !important;
    box-shadow:none !important;
    transition:transform .12s ease;
  }
  #btn-abrir-carpeta-cuenta.btn-icon:hover{ transform:scale(1.08); }
  #btn-abrir-carpeta-cuenta.btn-icon:active{ transform:scale(.94); }
  #btn-abrir-carpeta-cuenta.btn-icon img{
    width:44px !important;
    height:44px !important;
    display:block;
    object-fit:contain;
    pointer-events:none;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));
  }

    .border-green { border: 2px solid #22c55e !important; }
  .border-red   { border: 2px solid #ef4444 !important; }
  .picker-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,.5);
    display: none; align-items: center; justify-content: center; z-index: 9999;
  }
  .picker-box {
    width: 90%; max-width: 520px; background: #fff; border-radius: 8px; padding: 16px;
  }
  .picker-grid {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 12px 0;
  }
  .picker-grid select { width: 100%; height: 180px; font-size: 16px; }
  .picker-actions { display:flex; gap: 8px; justify-content: flex-end; }
  .btn { padding: 8px 14px; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; }
  .btn-ok { background: #16a34a; color: #fff; border-color: #16a34a; }
  .btn-cancel { background: #fff; color: #111; }

    /* Objetivo: en pantallas peque√±as
   1) Los iconos (WhatsApp/Drive) quedan en la primera fila (visibles).
   2) Los dos botones grandes (‚ÄúMOSTRAR DETALLES‚Äù y ‚ÄúGUARDAR ESTADO‚Äù) pasan a una segunda fila.
   3) Si la pantalla es muy angosta, los botones se apilan. */
@media (max-width:700px){
  .contr-actions{
    flex-wrap: wrap !important;
    align-items: center;
  }
  /* Fila 1: iconos a la derecha */
  .contr-actions .right-group{
    order: 1 !important;
    flex: 0 0 100% !important;   /* ocupa toda la fila 1 */
    justify-content: flex-end !important;
    margin-left: 0 !important;
    margin-top: 0 !important;
  }
  /* Fila 2: los dos botones */
  .contr-actions .left-group{
    order: 2 !important;
    flex: 0 0 100% !important;   /* toda la fila 2 */
    min-width: 0;
    margin-top: 8px;
    display: flex;
    gap: 12px;
  }
  /* Dos botones lado a lado en la segunda fila */
  .contr-actions .left-group > button{
    flex: 1 1 48%;
  }
}
/* Extra: si la pantalla es MUY estrecha, apila los botones verticalmente */
@media (max-width:400px){
  .contr-actions .left-group > button{
    flex: 1 1 100%;
  }
}
</style>
</head>
<body>
 <!-- Loader -->
<div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
  <div class="spinner-ios" role="status" aria-label="Cargando">
    <i></i><i></i><i></i><i></i><i></i><i></i>
    <i></i><i></i><i></i><i></i><i></i><i></i>
  </div>
</div>

  <div class="container">

    <!-- VISTA INSTALAR -->
    <section id="view-instalar" class="view">
      <div class="card narrow" style="text-align:center;">
        <h2 style="color:var(--primary);">APP CONTRATACI√ìN</h2>
        <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" />
        <p style="font-weight:600;">Herramienta de uso exclusivo para el equipo de Contrataci√≥n de la Alcald√≠a de Flandes</p>
        <div class="btn-row" style="justify-content:center; margin-top:12px;">
          <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
        </div>
        <p class="muted" style="margin-top:14px;">Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.</p>
      </div>
    </section>

    <!-- VISTA LOGIN -->
    <section id="view-login" class="view">
      <div class="card narrow">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">CONTRATACI√ìN</h1>
        <p class="helper"><b>Solo el personal del √°rea de contrataci√≥n de la Alcald√≠a de Flandes est√° autorizado para hacer uso de esta App.</b></p>

        <label>Contrase√±a</label>
       <div class="pwd-wrapper">
  <input
    id="login-cedula"
    type="password"
    inputmode="numeric"
    autocomplete="off"
    placeholder="Sin puntos ni espacios"
  />
  <button
    type="button"
    id="toggle-cedula"
    aria-label="Mostrar c√©dula"
    class="toggle-cedula"
  >
    <img
      src="https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png"
      alt="Mostrar"
    >
  </button>
</div>
        
        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
        </div>

        
        <img class="banner-bottom" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA INICIO -->
    <section id="view-inicio" class="view">
      <div class="card">
        <div class="btn-row" style="margin-bottom:12px;">
          <button class="danger" id="btn-logout">Cerrar Sesi√≥n</button>
        </div>

        <h2 id="inicio-profesional" style="color:var(--primary); font-weight:900;"></h2>
        <p id="inicio-fecha" class="center" style="font-weight:700; font-size:.95rem;"></p>

        <div class="btn-row spaced">
          <button id="go-contratistas" class="btn-primary">CONTRATISTAS</button>
          <button id="go-revision" class="btn-primary">REVISAR CUENTAS</button>
          <button id="go-requerimientos" class="btn-primary">REQUERIMIENTO</button>
          <button id="go-comunicados" class="btn-primary">COMUNICADOS</button>
          <button id="go-soporte" class="btn-primary">SOPORTE</button>
        </div>

        <img class="banner-bottom" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA CONTRATISTAS -->
    <section id="view-contratistas" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">CONTRATISTAS</h2>

        <div class="center">
          <div id="contr-count" class="tag-count" style="display:none;"></div>
          <p id="contr-caption" class="muted" style="margin:6px 0 12px;">N¬∞ de Contratistas OPS</p>
        </div>

        <input id="contr-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento, secretaria, supervisor o tel√©fono" aria-label="Filtrar contratistas">

        <div class="btn-row spaced">
          <button id="btn-add-contratista" class="btn-primary">AGREGAR CONTRATISTA</button>
          <button id="contr-volver" class="danger">REGRESAR</button>
        </div>

        <div id="contr-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA AGREGAR CONTRATISTA -->
    <section id="view-agregar" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">AGREGANDO CONTRATISTA</h2>

        <label>Documento</label>
        <input id="add-documento" type="tel" inputmode="numeric" placeholder="Sin puntos ni espacios">

        <label>Nombre del Contratista</label>
        <input id="add-nombre" type="text" placeholder="Nombre completo">

        <label>Secretar√≠a</label>
        <select id="add-secretaria">
          <option value="" disabled selected>Selecciona la Secretar√≠a</option>
          <option value="DESPACHO MUNICIPAL">DESPACHO MUNICIPAL</option>
          <option value="SECRETAR√çA DE GOBIERNO Y SERVICIOS ADMINISTRATIVOS">SECRETAR√çA DE GOBIERNO Y SERVICIOS ADMINISTRATIVOS</option>
          <option value="SECRETAR√çA DE HACIENDA">SECRETAR√çA DE HACIENDA</option>
          <option value="SECRETAR√çA DE EDUCACI√ìN, DESARROLLO ECON√ìMICO Y SOCIAL">SECRETAR√çA DE EDUCACI√ìN, DESARROLLO ECON√ìMICO Y SOCIAL</option>
          <option value="SECRETAR√çA DE PLANEACI√ìN E INFRAESTRUCTURA">SECRETAR√çA DE PLANEACI√ìN E INFRAESTRUCTURA</option>
          <option value="SECRETAR√çA DE ASUNTOS AGROPECUARIOS">SECRETAR√çA DE ASUNTOS AGROPECUARIOS</option>
          <option value="SECRETAR√çA DE SALUD">SECRETAR√çA DE SALUD</option>
        </select>

        <input id="add-carpetaSecretaria" type="hidden">

        <label>Supervisor</label>
        <select id="add-supervisor">
          <option value="" disabled selected>Selecciona Supervisor</option>
          <option value="ANA JUDITH GAMBOA MANTILLA">ANA JUDITH GAMBOA MANTILLA</option>
          <option value="LADY BRIGITTE GUERRERO MU√ëOZ">LADY BRIGITTE GUERRERO MU√ëOZ</option>
          <option value="LUZ HAYDEE ORTEGA MAYORGA">LUZ HAYDEE ORTEGA MAYORGA</option>
          <option value="VALENTINA P√ÅEZ GUZM√ÅN">VALENTINA P√ÅEZ GUZM√ÅN</option>
          <option value="JOSE ARCESIO VARGAS BENITEZ">JOSE ARCESIO VARGAS BENITEZ</option>
          <option value="JOHAN SEBASTI√ÅN CUARTAS GUAR√çN">JOHAN SEBASTI√ÅN CUARTAS GUAR√çN</option>
          <option value="YEIMY SUGEY ORTIZ SAENZ">YEIMY SUGEY ORTIZ SAENZ</option>
          <option value="JHONATAN RODRIGUEZ BELTRAN">JHONATAN RODRIGUEZ BELTRAN</option>
          <option value="SANDRA YULIETH BERNAL ARIAS">SANDRA YULIETH BERNAL ARIAS</option>
          <option value="LIDA ERIKA SANCHEZ PE√ëA">LIDA ERIKA SANCHEZ PE√ëA</option>
        </select>

        <input id="add-contactoSupervisor" type="hidden">

   <label>Contrato</label>
<input id="add-contrato" type="tel" inputmode="numeric" placeholder="Ej: 002" maxlength="3">

<label>Tipo de Contrato</label>
<select id="add-tipoContrato" required>
  <option value="" disabled selected>Selecciona el tipo de Contrato</option>
  <option value="PRESTACI√ìN DE SERVICIOS PROFESIONALES">PRESTACI√ìN DE SERVICIOS PROFESIONALES</option>
  <option value="PRESTACI√ìN DE SERVICIOS DE APOYO A LA GESTI√ìN">PRESTACI√ìN DE SERVICIOS DE APOYO A LA GESTI√ìN</option>
</select>

<label>Fecha del Contrato</label>
<input
  id="add-fechaContrato"
  type="text"
  placeholder="dd/mm/2026"
  required
  readonly
  onclick="abrirPickerFecha()" />

<!-- ocultos requeridos -->
<input id="add-diaContrato" type="text" style="display:none;">
<input id="add-mesContrato" type="text" style="display:none;">
<input id="add-mra" type="number" value="0" style="display:none;">

<label>Valor del Contrato</label>
<input id="add-valor" type="tel" inputmode="numeric" placeholder="Sin puntos ni espacios" maxlength="8">

<textarea id="add-valorTexto" rows="2" placeholder="Campo Autom√°tico" readonly></textarea>

<label>CDP N¬∞</label>
<input id="add-cdp" type="tel" inputmode="numeric" placeholder="10 d√≠gitos" maxlength="10">

  <label>Objeto del Contrato</label>
<textarea id="add-objeto" rows="3" placeholder="Describe el objeto del contrato" required></textarea>

<label>Obligaciones</label>
<textarea id="add-obligaciones" rows="3" placeholder="Una obligaci√≥n por l√≠nea (puede iniciar con 1., 2., 3., ...)" required></textarea>

<!-- Modal Picker (mantienes tu modal y l√≥gica) -->
<div id="fechaModal" class="picker-modal" aria-hidden="true">
  <div class="picker-box">
    <h3 style="margin:0 0 8px 0;">Selecciona la fecha</h3>
    <div class="picker-grid">
      <div>
        <small>D√≠a</small>
        <select id="pickerDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="pickerMes" size="12"></select>
      </div>
      <div>
        <small>A√±o</small>
        <select id="pickerAnio" size="3" disabled>
          <option selected>2026</option>
        </select>
      </div>
    </div>
    <div class="picker-actions">
      <button type="button" class="btn btn-cancel" onclick="cancelarPickerFecha()">Cancelar</button>
      <button type="button" class="btn btn-ok" onclick="confirmarPickerFecha()">Ok</button>
    </div>
  </div>
</div>

        <div class="btn-row spaced">
          <button id="btn-add-guardar" class="btn-primary">Guardar</button>
          <button id="btn-add-volver" class="danger">Regresar</button>
        </div>

        <p class="center muted spaced"><b>Revisa muy bien la informaci√≥n antes de Guardar</b></p>
      </div>
    </section>

    <!-- VISTA DETALLES CONTRATISTA -->
    <section id="view-detalles" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">DETALLES DE CONTRATISTA</h2>
        <div id="detalles-body" class="narrow"></div>
        <div class="btn-row spaced">
          <button id="detalles-ocultar" class="danger">OCULTAR</button>
        </div>
      </div>
    </section>

    <!-- VISTA REVISI√ìN DE CUENTAS -->
    <section id="view-revision" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">REVISI√ìN DE CUENTAS</h2>

        <div class="center">
          <div id="cuentas-count" class="tag-count" style="display:none;"></div>
          <p class="muted" style="margin:6px 0 12px;">N¬∞ de Cuentas Pendientes</p>
        </div>

        <input id="cuentas-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento, informe o total informes">

        <div class="btn-row spaced">
          <button id="revision-volver" class="danger">REGRESAR</button>
        </div>

        <div id="cuentas-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA REVISAR CUENTA -->
    <section id="view-revisar-cuenta" class="view">
      <div class="card">
        <h2 id="rc-title" style="color:var(--primary)">REVISI√ìN DE CUENTA</h2>
        <div id="rc-body" class="narrow"></div>

        <div class="section-toggle">
          <button id="btn-toggle-contrato" class="chip">Ver Informaci√≥n del Contrato</button>
        </div>
        <div id="sec-contrato" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-informe" class="chip">Ver Relaci√≥n de Informe y Pago</button>
        </div>
        <div id="sec-informe" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-planilla" class="chip">Ver Relaci√≥n de Planilla</button>
        </div>
        <div id="sec-planilla" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-planilla2" class="chip">Ver Relaci√≥n de Planilla Anexa</button>
        </div>
        <div id="sec-planilla2" class="section-content hidden"></div>

        <div class="section-toggle">
  <button id="btn-toggle-actividades" class="chip">Ver Relaci√≥n de Actividades</button>
</div>

<!-- Bot√≥n CUENTA debajo del bot√≥n de Actividades -->
<div class="center" style="margin-top:6px;">
  <button
    id="btn-abrir-carpeta-cuenta"
    class="btn-icon hidden"
    aria-label="Abrir carpeta de CUENTA en Drive"
    title="Abrir carpeta de CUENTA en Drive"
  >
    <img
      src="https://res.cloudinary.com/dqqeavica/image/upload/v1764111247/carpeta_drive_epbrhp.webp"
      alt="CUENTA"
    >
  </button>
</div>

<div id="sec-actividades" class="section-content hidden">
  <div id="actividades-blocks"></div>

</div>
        
        <h3 style="color:var(--primary); margin-top:18px;">TUS OBSERVACIONES</h3>
        <textarea id="rc-observaciones" rows="4" placeholder="Edita solo si vas a devolver la cuenta‚Ä¶"></textarea>

        <div class="btn-row spaced">
          <button id="rc-guardar" class="btn-primary">Guardar</button>
          <button id="rc-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA REQUERIMIENTOS -->
    <section id="view-requerimientos" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">REQUERIMIENTOS</h2>
        <div class="center">
          <div id="req-count" class="tag-count" style="display:none;"></div>
          <p class="muted" style="margin:6px 0 12px;">N¬∞ de Contratistas</p>
        </div>
        <input id="req-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento, secretaria, supervisor o tel√©fono">
        <div id="req-list" class="list-grid"></div>
        <div class="btn-row spaced">
          <button id="req-volver" class="danger">REGRESAR</button>
        </div>
      </div>
    </section>

    <!-- MODAL REQUERIMIENTO -->
    <div id="modal-requerimiento" class="modal-backdrop hidden">
      <div class="modal">
        <h3 style="color:var(--primary)">Redacta tu Requerimiento</h3>
        <textarea id="modal-req-text" rows="5" placeholder="Redacta el Requerimiento"></textarea>
        <div class="btn-row" style="margin-top:14px;">
          <button id="modal-req-enviar" class="btn-primary">Enviar</button>
          <button id="modal-req-cancelar" class="danger">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- VISTA COMUNICADOS -->
    <section id="view-comunicados" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">EMITE COMUNICADO</h2>
        <textarea id="comunicado-text" rows="6" placeholder="Escribe tu comunicado"></textarea>
        <div class="btn-row spaced">
          <button id="comunicado-enviar" class="btn-primary">Enviar</button>
          <button id="comunicado-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA SOPORTE -->
    <section id="view-soporte" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">¬øQU√â NECESITAS?</h2>
        <textarea id="soporte-text" rows="6" placeholder="Redacta detalladamente tu pregunta o sugerencia"></textarea>
        <div class="btn-row spaced">
          <button id="soporte-enviar" class="btn-primary">Enviar</button>
          <button id="soporte-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

  </div>

<script>
/* ================== CONFIGURACI√ìN PRINCIPAL ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxrDWVwRyjKheTVrijr8cPSVLd_iMZUb1qCuLB1c6PkJQktHc9Mhp2bduGqHK2sTW6PJg/exec';
const BUILDERBOT_ENDPOINT = 'https://app.builderbot.cloud/api/v2/ff37a123-12b0-4fdc-9866-f3e2daf389fb/messages';
const BUILDERBOT_API_KEY  = 'bb-7f9ef630-5cfc-4ba4-9258-5e7cecbb4f65';

/* ================== SONIDOS ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
  logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
};
function playSoundOnce(url){
  try{
    const a = new Audio(url);
    a.preload = 'auto';
    a.play().catch(()=>{});
  }catch(e){}
}
if (window.Swal && typeof Swal.fire === 'function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options = {}, ...rest){
    try{
      const icon = options.icon || options.type;
      if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
    }catch(e){}
    return __fire(options, ...rest);
  }
}

/* ================== LOADER ================== */
const loader = document.getElementById('loader');
let loadingCount = 0;
let loaderTimer = null;

function startLoading(){
  loadingCount++;
  if (loadingCount === 1){
    loaderTimer = setTimeout(()=>{
      loader.classList.remove('hidden');
      loaderTimer = null;
    }, 120);
  }
}
function stopLoading(){
  if (loadingCount === 0) return;
  loadingCount--;
  if (loadingCount === 0){
    if (loaderTimer){
      clearTimeout(loaderTimer);
      loaderTimer = null;
    }
    loader.classList.add('hidden');
  }
}

/* ================== API HELPERS ================== */
async function apiGet(action, params = {}){
  startLoading();
  try{
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({ action, ...params }).toString();
    const r = await fetch(url.toString(), { method: 'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}
async function apiPost(action, body = {}){
  startLoading();
  try{
    const url = API_BASE + '?action=' + encodeURIComponent(action);
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}

/* ================== BUILDERBOT ================== */
function normalizeContratistaNumber(raw){
  let num = String(raw || '').replace(/\D/g,'');
  if(!num) return '';
  // Si tiene 10 d√≠gitos y no comienza con 57, agregamos prefijo.
  if(num.length === 10 && !num.startsWith('57')){
    num = '57' + num;
  }
  // Formato v√°lido esperado: 12 d√≠gitos iniciando en 57
  if(!(num.length === 12 && num.startsWith('57'))){
    return '';
  }
  return num;
}

function sendBuilderbotMessage(destino, mensaje){
  const numberField = String(destino || '').trim();
  if(!numberField){
    console.warn('Destino vac√≠o, no se env√≠a BuilderBot');
    return;
  }
  fetch(BUILDERBOT_ENDPOINT, {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-builderbot':BUILDERBOT_API_KEY
    },
    body: JSON.stringify({
      messages: { content: mensaje },
      number: numberField,       // Puede ser n√∫mero normalizado o ID de grupo
      checkIfExists: false
    })
  }).catch(err => console.warn('Error enviando BuilderBot', err));
}

/* ================== ESTADO GLOBAL ================== */
let currentUser = null;

/* ================== VISTAS ================== */
function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  const v = document.getElementById(id);
  if(v) v.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ================== LOGIN ================== */
const btnLogin = document.getElementById('btn-login');
const loginCedula = document.getElementById('login-cedula');
  
/* ================== BOT√ìN OCULTAR - MOSTRAR ================== */
  const toggleCedulaBtn = document.getElementById('toggle-cedula');
toggleCedulaBtn.addEventListener('click', ()=>{
  const oculto = loginCedula.type === 'password';
  loginCedula.type = oculto ? 'text' : 'password';
  const nuevoIcono = oculto
    ? 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Ocultar_lgdxpd.png'
    : 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png';
  const accion = oculto ? 'Ocultar' : 'Mostrar';
  toggleCedulaBtn.setAttribute('aria-label', accion + ' c√©dula');
  toggleCedulaBtn.innerHTML = '<img src="'+nuevoIcono+'" alt="'+accion+'">';
});

btnLogin.addEventListener('click', async () => {
  const cedula = (loginCedula.value || '').trim();
  if (cedula === '') {
    Swal.fire({ icon:'warning', title:'Ingresa la C√©dula', text:'Campo requerido.' });
    return;
  }
  if (!/^\d{6,10}$/.test(cedula)) {
    Swal.fire({ icon:'warning', title:'C√©dula inv√°lida', text:'Debe tener de 6 a 10 d√≠gitos SIN PUNTOS NI ESPACIOS' });
    return;
  }
  try {
    const res = await apiGet('login', { cedula });
    if (!res || !res.encontrado){
  // Abrir WhatsApp al n√∫mero de soporte con mensaje armado
  const soporte = '573103230712';
  const mensaje = 
    'Buen d√≠a *Oscar*%0A%0ANo tengo acceso a la app de Contrataci√≥n.%0A' +
    'Mi c√©dula: *' + cedula + '*%0A' +
    'Te dejo mis datos a continuaci√≥n:%0A*Nombre Completo:*%0A*Celular:*';
  const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent);
  // En m√≥viles se puede usar el esquema whatsapp://; en desktop la URL web
  const urlWA = esMovil 
    ? 'whatsapp://send?phone=' + soporte + '&text=' + mensaje
    : 'https://api.whatsapp.com/send?phone=' + soporte + '&text=' + mensaje;
  window.open(urlWA, '_blank');

  await Swal.fire({
    icon:'error',
    title:'SIN ACCESO',
    html:'Se abri√≥ WhatsApp para que solicites la habilitaci√≥n.',
    timer:6000,
    showConfirmButton:false
  });
  return;
}
    currentUser = {
      cedula,
      profesional: res.profesional || '',
      celular: res.celular || ''
    };
    playSoundOnce(SOUNDS.login);
    renderInicio();
    showView('view-inicio');
  } catch (e) {
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  currentUser = null;
  loginCedula.value = '';
  showView('view-login');
});

/* ================== INICIO ================== */
function renderInicio(){
  document.getElementById('inicio-profesional').textContent = 'PROFESIONAL: ' + (currentUser?.profesional || '');
  document.getElementById('inicio-fecha').textContent = formatoFechaHumana(new Date());
}
function formatoFechaHumana(date){
  const dias=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
  const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const d=dias[date.getDay()];
  const dia=('0'+date.getDate()).slice(-2);
  const mes=meses[date.getMonth()];
  const y=date.getFullYear();
  return `${d}, ${dia} de ${mes} de ${y}`;
}
function formatoFechaHoraCorta(date){
  let h=date.getHours(); const min=('0'+date.getMinutes()).slice(-2);
  const ampm=h<12?'AM':'PM'; h=h%12||12;
  const dd=('0'+date.getDate()).slice(-2);
  const mm=('0'+(date.getMonth()+1)).slice(-2);
  const yyyy=date.getFullYear();
  return `${dd}/${mm}/${yyyy} ${h}:${min} ${ampm}`;
}

/* ================== NAVEGACI√ìN PRINCIPAL ================== */
document.getElementById('go-contratistas').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  await cargarContratistas();
  showView('view-contratistas');
});
document.getElementById('go-revision').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  await cargarCuentasPendientes();
  showView('view-revision');
});
document.getElementById('go-requerimientos').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  await cargarRequerimientosBase();
  showView('view-requerimientos');
});
document.getElementById('go-comunicados').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  showView('view-comunicados');
});
  
document.getElementById('go-soporte').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  showView('view-soporte');
});

/* ================== CONTRATISTAS ================== */
let CONTR_DATA=[];
async function cargarContratistas(){
  try{
    const list=await apiGet('listContratistas');
    CONTR_DATA=Array.isArray(list)?list:[];
    pintarContratistas(CONTR_DATA);
    actualizarResumenContratistas(CONTR_DATA);
  }catch(e){
    CONTR_DATA=[];
    pintarContratistas(CONTR_DATA);
    actualizarResumenContratistas(CONTR_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function actualizarResumenContratistas(list){
  const box=document.getElementById('contr-count');
  if(!box) return;
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent=String(list.length);
  box.style.display='inline-block';
}
function pintarContratistas(list){
  const wrap=document.getElementById('contr-list');
  if(!wrap) return;
  wrap.innerHTML='';
  if(!list.length){
    wrap.innerHTML='<p class="muted center">No hay contratistas activos.</p>';
    return;
  }
  for(const c of list){
    const div=document.createElement('div');
    div.className='item-card';

    const header=document.createElement('div');
    header.className='item-header';

    const title=document.createElement('p');
    title.className='item-title';
    title.textContent= (c.nombre||'');

    const estadoSpan = document.createElement('span');
    estadoSpan.className = 'estado-badge ' + (c.estado === 'ACTIVO' ? '' : 'inactivo');
    estadoSpan.textContent = c.estado;
    let nuevoEstado = c.estado;
    estadoSpan.style.cursor='pointer';
    estadoSpan.title='Tocar para alternar entre ACTIVO e INACTIVO';
    estadoSpan.addEventListener('click', ()=>{
      nuevoEstado = (nuevoEstado === 'ACTIVO' ? 'INACTIVO' : 'ACTIVO');
      estadoSpan.textContent = nuevoEstado;
      estadoSpan.className = 'estado-badge ' + (nuevoEstado === 'ACTIVO' ? '' : 'inactivo');
    });

    header.appendChild(title);
    header.appendChild(estadoSpan);
    div.appendChild(header);

    const pDoc=document.createElement('p');
    pDoc.className='item-sub';
    pDoc.textContent='CC: '+(c.documento||'');
    div.appendChild(pDoc);

    const pSec=document.createElement('p');
    pSec.className='item-sub';
    pSec.textContent='SECRETAR√çA: '+(c.secretaria||'');
    div.appendChild(pSec);

    const pSup=document.createElement('p');
    pSup.className='item-sub';
    pSup.textContent='SUPERVISOR: '+(c.supervisor||'');
    div.appendChild(pSup);

    const pContrato=document.createElement('p');
    pContrato.className='item-sub';
    pContrato.textContent='CONTRATO: '+(c.contrato||'')+' de: '+(c.fechaContrato||'');
    div.appendChild(pContrato);

    const pInicio=document.createElement('p');
    pInicio.className='item-sub';
    pInicio.textContent='FECHA INICIO: '+(c.fechaInicio||'');
    div.appendChild(pInicio);

    const pTermino=document.createElement('p');
    pTermino.className='item-sub';
    pTermino.textContent='FECHA TERMINO: '+(c.fechaTermino||'');
    div.appendChild(pTermino);

    const actionsRow=document.createElement('div');
    actionsRow.className='contr-actions';

    const leftGroup=document.createElement('div');
    leftGroup.className='left-group';

    const rightGroup=document.createElement('div');
    rightGroup.className='right-group';

    const btnDetalles=document.createElement('button');
btnDetalles.textContent='MOSTRAR DETALLES';
btnDetalles.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  mostrarDetallesContratista(c.documento);
});

    const btnGuardarEstado=document.createElement('button');
    btnGuardarEstado.textContent='GUARDAR ESTADO';
    btnGuardarEstado.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  try{
    await apiPost('guardarEstadoContratista',{ documento:c.documento, estado:nuevoEstado });
    Swal.fire({icon:'success',title:'Estado actualizado',timer:1600,showConfirmButton:false});
    await cargarContratistas();
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});

    const btnWhatsapp=document.createElement('button');
    btnWhatsapp.className='btn-icon';
    btnWhatsapp.innerHTML='<img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" alt="WhatsApp">';
    btnWhatsapp.setAttribute('aria-label','Abrir chat de WhatsApp');
    btnWhatsapp.addEventListener('click', ()=>{
      let tel=String(c.telefono||'').replace(/\D/g,'');
      if(!tel){ Swal.fire({icon:'info',title:'Sin tel√©fono'}); return; }
      if(!tel.startsWith('57')) tel='57'+tel;
      if(!/^57\d{10}$/.test(tel)){
        Swal.fire({icon:'warning',title:'Tel√©fono inv√°lido'}); return;
      }
      window.open('https://wa.me/'+tel,'_blank');
    });

    const btnDrive=document.createElement('button');
    btnDrive.className='btn-icon';
    btnDrive.innerHTML='<img src="https://res.cloudinary.com/dqqeavica/image/upload/v1763997280/DRIVE_bycgsc.webp" alt="Drive">';
    btnDrive.setAttribute('aria-label','Abrir carpeta Drive');
    btnDrive.addEventListener('click', ()=>{
      if(c.carpetaContratista){
        window.open('https://drive.google.com/drive/folders/'+c.carpetaContratista,'_blank');
      }else{
        Swal.fire({icon:'info',title:'Sin carpeta',text:'No hay carpeta asociada.'});
      }
    });

    leftGroup.appendChild(btnDetalles);
    leftGroup.appendChild(btnGuardarEstado);
    rightGroup.appendChild(btnWhatsapp);
    rightGroup.appendChild(btnDrive);
    actionsRow.appendChild(leftGroup);
    actionsRow.appendChild(rightGroup);

    div.appendChild(actionsRow);
    wrap.appendChild(div);
  } 
} 

document.getElementById('contr-filter').addEventListener('input',()=>{
  const q=document.getElementById('contr-filter').value.trim().toLowerCase();
  const filtered=CONTR_DATA.filter(c=>{
    return [c.nombre,c.documento,c.secretaria,c.supervisor,c.telefono]
      .some(v=>String(v||'').toLowerCase().includes(q));
  });
  pintarContratistas(filtered);
  actualizarResumenContratistas(filtered);
});
document.getElementById('contr-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== AGREGAR CONTRATISTA ================== */
const MAP_SECRETARIA_CARPETA={
  'DESPACHO MUNICIPAL':'1KkTSaWUnNkKzES_Drn7cO449hYYDT-Pd',
  'SECRETAR√çA DE GOBIERNO Y SERVICIOS ADMINISTRATIVOS':'1X5spQ24vs5wzZyI1AtiMMMBrTCzKMNOH',
  'SECRETAR√çA DE HACIENDA':'1v_0D71jH-9nK0HgAWr5gzLHxRCF3R2bG',
  'SECRETAR√çA DE EDUCACI√ìN, DESARROLLO ECON√ìMICO Y SOCIAL':'1EM4GpZB29vaxCABp3T--dN9bYy9z0eJz',
  'SECRETAR√çA DE PLANEACI√ìN E INFRAESTRUCTURA':'1Z7FrxQc8APQQjabcZvf9kLLwT5nodD0g',
  'SECRETAR√çA DE ASUNTOS AGROPECUARIOS':'1kiDmMAzHGUjWn3UEI_mjhzJkDvXBcCRe',
  'SECRETAR√çA DE SALUD':'1c87Bg1pQQ6ydrtG7dTEVyByWqUHrWnMD'
};
const MAP_SUPERVISOR_CONTACTO={
  'ANA JUDITH GAMBOA MANTILLA':'573204832824',
  'LADY BRIGITTE GUERRERO MU√ëOZ':'573134815822',
  'LUZ HAYDEE ORTEGA MAYORGA':'573222622322',
  'VALENTINA P√ÅEZ GUZM√ÅN':'573104569019',
  'JOSE ARCESIO VARGAS BENITEZ':'573155844147',
  'JOHAN SEBASTI√ÅN CUARTAS GUAR√çN':'573106307707',
  'YEIMY SUGEY ORTIZ SAENZ':'573203469760',
  'JHONATAN RODRIGUEZ BELTRAN':'573115574000',
  'SANDRA YULIETH BERNAL ARIAS':'3108865269',
  'LIDA ERIKA SANCHEZ PE√ëA':'573133641048'
};

document.getElementById('btn-add-contratista').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  showView('view-agregar');
});
document.getElementById('add-secretaria').addEventListener('change',()=>{
  const val=document.getElementById('add-secretaria').value;
  document.getElementById('add-carpetaSecretaria').value=MAP_SECRETARIA_CARPETA[val]||'';
});
document.getElementById('add-supervisor').addEventListener('change',()=>{
  const val=document.getElementById('add-supervisor').value;
  document.getElementById('add-contactoSupervisor').value=MAP_SUPERVISOR_CONTACTO[val]||'';
});
document.getElementById('btn-add-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-contratistas');
});

document.getElementById('btn-add-guardar').addEventListener('click',async()=>{
  const documento=(document.getElementById('add-documento').value||'').trim();
  const nombre=(document.getElementById('add-nombre').value||'').trim();
  const secretaria=(document.getElementById('add-secretaria').value||'').trim();
  const carpetaSecretaria=(document.getElementById('add-carpetaSecretaria').value||'').trim();
  const supervisor=(document.getElementById('add-supervisor').value||'').trim();
  const contacto=(document.getElementById('add-contactoSupervisor').value||'').trim();

  // NUEVOS CAMPOS
  const contratoRaw=(document.getElementById('add-contrato').value||'').trim();
  const tipoContrato=(document.getElementById('add-tipoContrato').value||'').trim();
  const fechaContrato=(document.getElementById('add-fechaContrato').value||'').trim();   // dd/mm/2026 del picker
  const diaContrato=(document.getElementById('add-diaContrato').value||'').trim();       // "01" del picker
  const mesContrato=(document.getElementById('add-mesContrato').value||'').trim();       // "Enero" del picker
  const valorRaw=(document.getElementById('add-valor').value||'').trim();                // ej: 15000000
  const mraRaw=(document.getElementById('add-mra').value||'').trim();                    // 0
  const valorTexto=(document.getElementById('add-valorTexto').value||'').trim();         // en may√∫sculas
  const cdp=(document.getElementById('add-cdp').value||'').trim();                       // 10 d√≠gitos

  const objetoRaw = (document.getElementById('add-objeto').value || '').trim();
const obligacionesRaw = (document.getElementById('add-obligaciones').value || '').trim();

// Validaciones requeridos
if (!objetoRaw){
  Swal.fire({icon:'warning',title:'Objeto del contrato requerido'}); return;
}
if (!obligacionesRaw){
  Swal.fire({icon:'warning',title:'Obligaciones requeridas'}); return;
}

// Normalizaci√≥n Objeto: romper saltos de l√≠nea -> espacio, colapsar espacios y MAY√öSCULAS
const objeto = objetoRaw
  .replace(/\r?\n+/g, ' ')
  .replace(/\s+/g, ' ')
  .trim()
  .toUpperCase();

// Normalizaci√≥n Obligaciones: crear subcampos (m√°ximo 26), limpiando n√∫mero y punto inicial
const obligaciones = obligacionesRaw
  .split(/\r?\n+/)
  .map(l => l.replace(/^\s*\d+\.\s*/, '').trim())  // limpia "1. ", "2. ", etc. al inicio
  .filter(Boolean)
  .slice(0, 26);

if (obligaciones.length === 0){
  Swal.fire({icon:'warning',title:'Debes ingresar al menos una obligaci√≥n'}); return;
}
  
  if(!/^\d{6,10}$/.test(documento)){
    Swal.fire({icon:'warning',title:'Documento inv√°lido'}); return;
  }
  const nombreParts=nombre.split(/\s+/).filter(Boolean);
  if(nombreParts.length<2){
    Swal.fire({icon:'warning',title:'Nombre incompleto',text:'Ingresa m√≠nimo nombre y apellido'}); return;
  }
  if(!secretaria || !supervisor || !carpetaSecretaria || !contacto){
    Swal.fire({icon:'warning',title:'Campos incompletos'}); return;
  }

  // Validaciones b√°sicas nuevas
  if(!contratoRaw){ Swal.fire({icon:'warning',title:'Contrato requerido'}); return; }
  if(!tipoContrato){ Swal.fire({icon:'warning',title:'Tipo de contrato requerido'}); return; }
  if(!fechaContrato || !/^\d{2}\/\d{2}\/\d{4}$/.test(fechaContrato)){
    Swal.fire({icon:'warning',title:'Fecha de contrato inv√°lida',text:'Usa el picker'}); return;
  }
  if(!diaContrato || !/^\d{2}$/.test(diaContrato)){
    Swal.fire({icon:'warning',title:'D√≠a de contrato inv√°lido'}); return;
  }
  if(!mesContrato){ Swal.fire({icon:'warning',title:'Mes de contrato requerido'}); return; }
  if(!/^\d{1,8}$/.test(valorRaw)){ Swal.fire({icon:'warning',title:'Valor inv√°lido'}); return; }
  if(!valorTexto){ Swal.fire({icon:'warning',title:'Valor en texto faltante'}); return; }
  if(!/^\d{10}$/.test(cdp)){ Swal.fire({icon:'warning',title:'CDP inv√°lido'}); return; }

  // Normalizaciones con ceros a la izquierda
  let numeroContrato = contratoRaw.replace(/\D/g,'');
  numeroContrato = ('000' + numeroContrato).slice(-3);   // 3 d√≠gitos
  const contratoCell = "'" + numeroContrato;             // fuerza texto en Sheets

  let dia2 = diaContrato.replace(/\D/g,'');
  dia2 = ('00' + dia2).slice(-2);                        // 2 d√≠gitos
  const diaContratoCell = "'" + dia2;                    // fuerza texto en Sheets

  const valorNum = Number(valorRaw.replace(/\D/g,'')) || 0;
  const mraNum   = Number(mraRaw.replace(/\D/g,'')) || 0;

  try{
    const res=await apiPost('agregarContratista',{
      documento,
      nombre:nombre.toUpperCase(),
      secretaria,
      carpetaSecretaria,
      supervisor,
      contacto,
      // ENV√çA AL BACKEND
      contrato: numeroContrato,      // el backend pondr√° el prefijo '
      tipoContrato,
      fechaContrato,                 // dd/mm/yyyy
      diaContrato: dia2,             // "02"
      mesContrato,                   // "Febrero"
      valor: String(valorNum),
      mra: String(mraNum),
      valorTexto: valorTexto.toUpperCase(),
      cdp,
      objeto,                     // X (columna 24 en Sheets)
      obligaciones                // arreglo de hasta 26
    });
    Swal.fire({icon:'success',title:'Contratista Agregado',timer:3000,showConfirmButton:false});
    await cargarContratistas();
    showView('view-contratistas');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});

/* ================== DETALLES CONTRATISTA ================== */
async function mostrarDetallesContratista(documento){
  try{
    const d=await apiGet('detallesContratista',{documento});
    const body=document.getElementById('detalles-body');
    body.innerHTML='';
    if(!d){
      body.innerHTML='<p class="muted center">No encontrado.</p>';
    }else{
      const lines=[
        `<b>NOMBRE:</b> ${d.nombre||''}`,
        `<b>CC:</b> ${d.documento||''} <b>de:</b> ${d.expedida||''}`,
        `<b>TELEFONO:</b> ${d.telefono||'SIN REGISTRO'}`,
        `<b>CORREO:</b> ${d.correo||'SIN REGISTRO'}`,
        `<b>CUENTA:</b> ${d.cuenta||''} ${d.tipoCuenta||''} ${d.banco||''}`,
        `<b>EPS:</b> ${d.eps||''}`,
        `<b>AFP:</b> ${d.pension||''}`,
        `<b>ARL:</b> ${d.arl||''}`,
        `<b>SECRETAR√çA:</b> ${d.secretaria||''}`,
        `<b>SUPERVISOR:</b> ${d.supervisor||''}`,
        `<b>CONTRATO:</b> ${d.contrato||''} <b>de:</b> ${d.fechaContrato||''}`,
        `<b>OBJETO:</b> ${d.objeto||''}`,
        `<b>FECHA DE INICIO:</b> ${d.fechaInicio||''}`,
        `<b>FECHA DE TERMINO:</b> ${d.fechaTermino||''}`,
        `<b>MRA:</b> ${d.mra||''}`,
        `<b>VALOR:</b> ${d.valorFinal||''}`,
        `<b>CDP:</b> ${d.cdp||''}`,
        `<b>RP:</b> ${d.rp||''}`,
        `<b>CDP ADICI√ìN:</b> ${d.cdpAdicion||''}`,
        `<b>RP ADICI√ìN:</b> ${d.rpAdicion||''}`,
        `<b>REGIMEN:</b> ${d.regimen||''}`
      ];
      for(let i=1;i<=26;i++){
        const val=d['obligacion'+i];
        if(val && val!=='-'){
          lines.push(`<b>OBLIGACI√ìN ${i}:</b> ${val}`);
        }
      }
      body.innerHTML=lines.map(l=>`<p>${l}</p>`).join('');
    }
    showView('view-detalles');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
document.getElementById('detalles-ocultar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-contratistas');
});

/* ================== REVISI√ìN DE CUENTAS (Listado) ================== */
let CUENTAS_DATA=[];
async function cargarCuentasPendientes(){
  try{
    const list=await apiGet('listCuentasPendientes');
    CUENTAS_DATA=Array.isArray(list)?list:[];
    pintarCuentas(CUENTAS_DATA);
    actualizarResumenCuentas(CUENTAS_DATA);
  }catch(e){
    CUENTAS_DATA=[];
    pintarCuentas(CUENTAS_DATA);
    actualizarResumenCuentas(CUENTAS_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function actualizarResumenCuentas(list){
  const box=document.getElementById('cuentas-count');
  if(!box) return;
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent=String(list.length);
  box.style.display='inline-block';
}
function pintarCuentas(list){
  const wrap=document.getElementById('cuentas-list');
  wrap.innerHTML='';
  if(!list.length){
    wrap.innerHTML='<p class="muted center">No hay cuentas pendientes.</p>';
    return;
  }
  for(const c of list){
    const div=document.createElement('div');
    div.className='item-card';

    const header=document.createElement('div');
    header.className='item-header';

    const title=document.createElement('p');
    title.className='item-title';
    title.textContent= (c.nombre||'');
    header.appendChild(title);

    const pDoc=document.createElement('p');
    pDoc.className='item-sub';
    pDoc.textContent='CC: '+(c.documento||'');

    const pInf=document.createElement('p');
    pInf.className='item-sub';
    pInf.textContent='INFORME: '+(c.informe||'')+' de: '+(c.totalInformes||'');

    const btnRow=document.createElement('div');
    btnRow.className='btn-row';

    const btnRevisar=document.createElement('button');
btnRevisar.textContent='REVISAR';
btnRevisar.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  abrirRevisionCuenta(c.documento);
});
    btnRow.appendChild(btnRevisar);

    if (c.telefono){
  const btnWhatsapp = document.createElement('button');
  btnWhatsapp.className = 'btn-icon';
  btnWhatsapp.innerHTML = '<img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" alt="WhatsApp">';
  btnWhatsapp.setAttribute('aria-label','Abrir chat de WhatsApp');
  btnWhatsapp.addEventListener('click', ()=>{
    let tel = String(c.telefono||'').replace(/\D/g,'');
    if(!tel){ Swal.fire({icon:'info',title:'Sin tel√©fono'}); return; }
    if(!tel.startsWith('57')) tel = '57' + tel;
    if(!/^57\d{10}$/.test(tel)){
      Swal.fire({icon:'warning',title:'Tel√©fono inv√°lido'}); return;
    }
    window.open('https://wa.me/'+tel,'_blank');
  });
  btnRow.appendChild(btnWhatsapp);
}

    div.appendChild(header);
    div.appendChild(pDoc);
    div.appendChild(pInf);
    div.appendChild(btnRow);
    wrap.appendChild(div);
  }
}
document.getElementById('cuentas-filter').addEventListener('input',()=>{
  const q=document.getElementById('cuentas-filter').value.trim().toLowerCase();
  const filtered=CUENTAS_DATA.filter(c=>{
    return [c.nombre,c.documento,c.informe,c.totalInformes]
      .some(v=>String(v||'').toLowerCase().includes(q));
  });
  pintarCuentas(filtered);
  actualizarResumenCuentas(filtered);
});
document.getElementById('revision-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== REVISAR CUENTA (Detalle) ================== */

  function resetSeccionesRevision(){
  const parts = [
    { sec:'sec-contrato',   btn:'btn-toggle-contrato',  label:'Ver Informaci√≥n del Contrato' },
    { sec:'sec-informe',    btn:'btn-toggle-informe',   label:'Ver Relaci√≥n de Informe y Pago' },
    { sec:'sec-planilla',   btn:'btn-toggle-planilla',  label:'Ver Relaci√≥n de Planilla' },
    { sec:'sec-planilla2',  btn:'btn-toggle-planilla2', label:'Ver Relaci√≥n de Planilla Anexa' },
    { sec:'sec-actividades',btn:'btn-toggle-actividades',label:'Ver Relaci√≥n de Actividades' }
  ];
  parts.forEach(({sec, btn, label})=>{
    const s = document.getElementById(sec);
    const b = document.getElementById(btn);
    if (s) s.classList.add('hidden');   // asegura cerrado
    if (b) b.textContent = label;       // restaura el texto "Ver ..."
  });
}
  
let REV_CUENTA=null;
async function abrirRevisionCuenta(documento){
  try{
    const data=await apiGet('revisarCuentaData',{documento});
    if(!data){
      Swal.fire({icon:'info',title:'No encontrado'}); return;
    }
    REV_CUENTA=data;
    resetSeccionesRevision();
    renderRevisionCuenta();
    showView('view-revisar-cuenta');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function renderRevisionCuenta(){
  const c=REV_CUENTA?.contratista;
  const cu=REV_CUENTA?.cuenta;
  const rcTitle=document.getElementById('rc-title');
  const rcBody=document.getElementById('rc-body');
  rcTitle.textContent='REVISI√ìN DE CUENTA N¬∞ '+(cu?.informe||'')+' de '+(c?.nombre||'');
  rcBody.innerHTML='';
  const baseInfo=[
    `<b>DOCUMENTO:</b> ${c?.documento||''}`,
    `<b>SECRETAR√çA:</b> ${c?.secretaria||''}`,
    `<b>SUPERVISOR:</b> ${c?.supervisor||''}`
  ];
  rcBody.innerHTML=baseInfo.map(x=>`<p>${x}</p>`).join('');

  const sContrato=document.getElementById('sec-contrato');
  sContrato.innerHTML=[
    `<b>CONTRATO N¬∞:</b> ${c?.contrato||''}`,
    `<b>FECHA DE CONTRATO:</b> ${c?.fechaContrato||''}`,
    `<b>FECHA DE INICIO:</b> ${c?.fechaInicio||''}`,
    `<b>FECHA DE TERMINO:</b> ${c?.fechaTermino||''}`,
    `<b>VALOR INICIAL:</b> ${c?.valor || '-'}`,
    `<b>MRA:</b> ${c?.mra||''}`,
    `<b>VALOR FINAL:</b> ${c?.valorFinal||''}`,
    `<b>CDP:</b> ${c?.cdp||''}`,
    `<b>RP:</b> ${c?.rp||''}`,
    `<b>CDP ADICI√ìN:</b> ${c?.cdpAdicion||''}`,
    `<b>RP ADICI√ìN:</b> ${c?.rpAdicion||''}`,
    `<b>SECRETAR√çA:</b> ${c?.secretaria||''}`,
    `<b>SUPERVISOR:</b> ${c?.supervisor||''}`,
  ].map(x=>`<p>${x}</p>`).join('');

  const sInforme=document.getElementById('sec-informe');
  sInforme.innerHTML=[
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE INFORME</h4>`,
    `<p><b>FECHA DE RADICACI√ìN:</b> ${cu?.fechaRadicacion||''}</p>`,
    `<p><b>INFORME:</b> ${cu?.informe||''} de ${cu?.totalInformes||''}</p>`,
    `<p><b>INICIO DE PERIODO RATIFICADO:</b> ${cu?.inicioRatificar||''}</p>`,
    `<p><b>FIN DE PERIODO RATIFICADO:</b> ${cu?.finRatificar||''}</p>`,
    `<h4 style="margin:14px 0 4px;color:var(--primary)">RELACI√ìN DE PAGO</h4>`,
    `<p><b>SALDO ACTUAL:</b> ${cu?.saldoActual||''}</p>`,
    `<p><b>VALOR COBRADO:</b> ${cu?.menos||''}</p>`,
    `<p><b>NUEVO SALDO:</b> ${cu?.nuevoSaldo||''}</p>`
  ].join('');

  const sPlanilla=document.getElementById('sec-planilla');
  sPlanilla.innerHTML=[
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE PLANILLA</h4>`,
    `<p><b>PLANILLA N¬∞:</b> ${cu?.planilla||''} de ${cu?.mesPlanilla||''}</p>`,
    `<p><b>BASE DE COTIZACI√ìN:</b> ${cu?.base||''}</p>`,
    `<p><b>APORTES A SALUD:</b> ${cu?.salud||''}</p>`,
    `<p><b>APORTES A PENSI√ìN:</b> ${cu?.fondo||''}</p>`,
    `<p><b>APORTES A ARL:</b> ${cu?.riesgos||''}</p>`,
    `<p><b>APORTES FPS:</b> ${cu?.solidario||''} ${cu?.aporte||''}</p>`
  ].join('');

  const sPlanilla2=document.getElementById('sec-planilla2');
  sPlanilla2.innerHTML=[
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE PLANILLA ANEXA</h4>`,
    `<p><b>PLANILLA ANEXA N¬∞:</b> ${cu?.planilla2||''} de ${cu?.mesPlanilla2||''}</p>`,
    `<p><b>BASE DE COTIZACI√ìN:</b> ${cu?.base2||''}</p>`,
    `<p><b>APORTES A SALUD:</b> ${cu?.salud2||''}</p>`,
    `<p><b>APORTES A PENSI√ìN:</b> ${cu?.fondo2||''}</p>`,
    `<p><b>APORTES A ARL:</b> ${cu?.riesgos2||''}</p>`,
    `<p><b>APORTES FPS:</b> ${cu?.solidario2||''} ${cu?.aporte2||''}</p>`
  ].join('');

  // === Actividades sin paginaci√≥n, mostrando solo las con contenido ===
  const blocksWrap=document.getElementById('actividades-blocks');
  blocksWrap.innerHTML='';
  const actividades=REV_CUENTA?.actividades||[];
  const evidencias=REV_CUENTA?.evidencias||[];
  const obligaciones=REV_CUENTA?.obligaciones||[];
  const total=obligaciones.length;

  function extraerDriveId(url){
    if(!url) return '';
    const primera=String(url).trim().split(/\s+/)[0];
    const patrones=[
      /\/d\/([A-Za-z0-9_-]{10,})/,
      /id=([A-Za-z0-9_-]{10,})/,
      /\/file\/d\/([A-Za-z0-9_-]{10,})/,
      /open\?[^#]*id=([A-Za-z0-9_-]{10,})/
    ];
    for(const rx of patrones){
      const m=primera.match(rx);
      if(m) return m[1];
    }
    return '';
  }

  function evidenciaThumb(url){
  const id=extraerDriveId(url);
  return id ? 'https://drive.google.com/thumbnail?sz=w1000&id='+id : url;
}
function evidenciaFull(url){
  if(!url) return '';
  const primera = String(url).trim().split(/\s+/)[0];
  const patrones = [
    /\/d\/([A-Za-z0-9_-]{10,})/,
    /id=([A-Za-z0-9_-]{10,})/,
    /\/file\/d\/([A-Za-z0-9_-]{10,})/,
    /open\?[^#]*id=([A-Za-z0-9_-]{10,})/
  ];
  let id = '';
  for(const rx of patrones){
    const m = primera.match(rx);
    if(m){ id = m[1]; break; }
  }
  return id
    ? 'https://drive.google.com/uc?export=view&id='+id
    : primera;
}

  // Helper de zoom con fallback
function abrirZoomEvidencia(src, titulo){
  const overlay = document.createElement('div');
  overlay.style.position='fixed';
  overlay.style.inset='0';
  overlay.style.background='rgba(0,0,0,.75)';
  overlay.style.zIndex='10000';
  overlay.style.display='flex';
  overlay.style.alignItems='center';
  overlay.style.justifyContent='center';
  overlay.style.padding='24px';

  const box = document.createElement('div');
  box.style.maxWidth='90%';
  box.style.maxHeight='90%';
  box.style.position='relative';
  box.style.background='#fff';
  box.style.borderRadius='14px';
  box.style.padding='12px';
  box.style.boxShadow='0 8px 24px rgba(0,0,0,.4)';
  box.style.display='flex';
  box.style.flexDirection='column';
  box.style.alignItems='center';
  box.style.gap='12px';

  const titleEl = document.createElement('h3');
  titleEl.textContent = titulo;
  titleEl.style.margin='0';
  titleEl.style.color='var(--primary)';
  titleEl.style.textAlign='center';

  const img = document.createElement('img');
  img.style.maxWidth='100%';
  img.style.maxHeight='70vh';
  img.style.borderRadius='10px';
  img.style.objectFit='contain';
  img.style.background='#f0f0f0';
  img.alt = titulo;

  const loaderMsg = document.createElement('p');
  loaderMsg.textContent='Cargando imagen‚Ä¶';
  loaderMsg.style.margin='0';
  loaderMsg.style.fontSize='.85rem';
  loaderMsg.style.color='#333';

  img.addEventListener('error', ()=>{
    if(src.includes('uc?export=view&id=')){
      const idMatch = src.match(/id=([A-Za-z0-9_-]{10,})/);
      if(idMatch){
        img.src = 'https://drive.google.com/thumbnail?sz=w1000&id='+idMatch[1];
        loaderMsg.textContent='(Vista alternativa)';
      }
    } else {
      loaderMsg.textContent='No se pudo cargar la evidencia.';
    }
  });
  img.addEventListener('load', ()=> loaderMsg.textContent='');

  img.src = src;

  const cerrarBtn = document.createElement('button');
  cerrarBtn.textContent='Cerrar';
  cerrarBtn.className='btn-primary';
  cerrarBtn.style.maxWidth='160px';
  cerrarBtn.addEventListener('click', ()=> document.body.removeChild(overlay));

  overlay.addEventListener('click', (e)=>{
    if(e.target === overlay){
      document.body.removeChild(overlay);
    }
  });

  box.appendChild(titleEl);
  box.appendChild(img);
  box.appendChild(loaderMsg);
  box.appendChild(cerrarBtn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

  for(let i=1;i<=total;i++){
    const oblig=obligaciones[i-1];
    const act=actividades[i-1];
    const evid=evidencias[i-1];

    if(![oblig,act,evid].some(v=>v && v!=='-')) continue;

    const block=document.createElement('div');
    block.className='oblig-block';

    const titulo=document.createElement('p');
    titulo.className='oblig-title';
    titulo.textContent='OBLIGACI√ìN N¬∞ '+i;
    block.appendChild(titulo);

    if(oblig && oblig!=='-'){
      const ob=document.createElement('p');
      ob.className='oblig-sub';
      ob.textContent=oblig; // sin prefijo "Obligaci√≥n:"
      block.appendChild(ob);
    }
    if(act && act!=='-'){
      const ac=document.createElement('p');
      ac.className='oblig-sub';
      ac.innerHTML='<b>Actividades:</b> '+act;
      block.appendChild(ac);
    }
    if(evid && evid!=='-'){
      const evDiv=document.createElement('div');
      evDiv.className='evidence-grid';
      const img=document.createElement('img');
      img.className='evidence-thumb';
      img.src=evidenciaThumb(evid);
      img.alt='Evidencia '+i;
      img.addEventListener('click', ()=>{
  const full = evidenciaFull(evid);
  abrirZoomEvidencia(full, 'Evidencia '+i);
});
      evDiv.appendChild(img);
      block.appendChild(evDiv);
    }
               blocksWrap.appendChild(block);
  }

    // === Mostrar/ocultar y parametrizar bot√≥n "CUENTA" (debajo de Actividades) ===
const cuentaBtn = document.getElementById('btn-abrir-carpeta-cuenta');
if (cu?.informe && c?.carpetaContratista){
  cuentaBtn.classList.remove('hidden');
  cuentaBtn.dataset.parent  = c.carpetaContratista;          // carpeta del contratista (padre)
  cuentaBtn.dataset.informe = String(cu.informe).trim();      // n√∫mero de informe
  if (cu?.idCuenta){                                         // ID directo de la subcarpeta (BH)
    cuentaBtn.dataset.subId = String(cu.idCuenta).trim();
  } else {
    delete cuentaBtn.dataset.subId;
  }
} else {
  cuentaBtn.classList.add('hidden');
  delete cuentaBtn.dataset.parent;
  delete cuentaBtn.dataset.informe;
  delete cuentaBtn.dataset.subId;
}
  
document.getElementById('rc-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  resetSeccionesRevision();     // cierra cualquier secci√≥n abierta
  showView('view-revision');    // vuelve a la lista
});


// Abrir directamente la subcarpeta "CUENTA <informe>" usando su ID (BH->idCuenta)
const btnAbrirCarpetaCuenta = document.getElementById('btn-abrir-carpeta-cuenta');
btnAbrirCarpetaCuenta.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);

  const subId = btnAbrirCarpetaCuenta.dataset.subId || '';
  const parentId = btnAbrirCarpetaCuenta.dataset.parent || REV_CUENTA?.contratista?.carpetaContratista || '';

  if (subId){
    window.open('https://drive.google.com/drive/folders/' + subId, '_blank');
    return;
  }

  // Fallback solo si no lleg√≥ BH: abre la carpeta del contratista
  if (parentId){
    Swal.fire({ icon:'info', title:'Falta id de CUENTA', text:'Se abrir√° la carpeta del contratista.' });
    window.open('https://drive.google.com/drive/folders/' + parentId, '_blank');
  } else {
    Swal.fire({ icon:'info', title:'Sin carpeta', text:'Este contratista no tiene "carpetaContratista" asociada.' });
  }
});
  
document.getElementById('rc-guardar').addEventListener('click', async ()=>{
  if(!REV_CUENTA?.cuenta){
    Swal.fire({icon:'warning',title:'Sin cuenta cargada'}); return;
  }
  const documento = REV_CUENTA.contratista.documento;
  const nombre    = REV_CUENTA.contratista.nombre;
  const informe   = REV_CUENTA.cuenta.informe;
  const supervisor        = REV_CUENTA.contratista.supervisor;
  const supervisorGrupoId = (REV_CUENTA.contratista.contacto || '').trim(); // ahora es grupo
  const telContratistaRaw = REV_CUENTA.contratista.telefono;
  const observ = (document.getElementById('rc-observaciones').value || '').trim();

  const telContratista = normalizeContratistaNumber(telContratistaRaw);

  const rs = await Swal.fire({
    icon:'success',
    title:`Haz revisado la cuenta N¬∞ ${informe} de ${nombre}`,
    text:'Toma una de las opciones.',
    showCancelButton:true,
    showDenyButton:true,
    confirmButtonText:'Aprobar',
    denyButtonText:'Devolver',
    cancelButtonText:'Cancelar'
  });

  function msgAprobado(){
    return (
      'Estimado(a) *'+nombre+'*\n\n' +
      '¬°Tu *Cuenta N¬∞ '+informe+'* ha sido *Aprobada*!, sigue estos pasos:\n' + 
      '- Descarga los documentos de la carpeta *CUENTA '+informe+'* en tu Drive.\n' + 
      '- Unificalos en orden aqu√≠: https://smallpdf.com/es/unir-pdf \n' + 
      '- Gu√°rdalos en tu dispositivo o computador con nombre t√©cnico *CTA'+informe+'-'+nombre+'*\n' + 
      '- s√∫belos al *Plan de Pagos en el Secop II*, recuerda "Enviar a la Entidad"\n\n' +
      'Una vez los subas, toma la opci√≥n *Reportar Plan de Pagos* en la *App Contratista*.\n' +
      '> Recuerda que, desde la segunda cuenta; debes relacionar la fecha en que la entidad te cancel√≥ los honorarios de la cuenta inmediatamente anterior.\n\n' +
      'Cordialmente,\n\n*Equipo de Contrataci√≥n*\n> Alcald√≠a de Flandes'
    );
  }
  function msgDevueltaContratista(){
    return (
      'Estimado(a) *'+nombre+'*\n\n' +
      'Se ha devuelto tu *Cuenta N¬∞ '+informe+'* por esta inconsistencia que omiti√≥ tu supervisor(a):\n\n*'+(observ || 'Sin observaciones')+'*\n\n' +
      'Haz la correcci√≥n desde la *App Contratista* teniendo en cuenta las observaciones anteriores.\n\n' +
      'Cordialmente,\n\n*Equipo de Contrataci√≥n*\n> Alcald√≠a de Flandes'
    );
  }
  function msgDevueltaSupervisor(){
    return (
      '‚ùå Estimado(a) *'+supervisor+'* ‚ùå\n\n' +
      'Se ha devuelto la *Cuenta N¬∞ '+informe+'* de *'+nombre+'* por esta inconsistencia:\n\n*'+(observ || 'Sin observaciones')+'*\n\n' +
      'El(la) Contratista ya ha sido notificado(a).\n\n' +
      'Cordialmente,\n\n*Equipo de Contrataci√≥n*'
    );
  }

  if(rs.isConfirmed){
    try{
      await apiPost('aprobarCuenta',{documento,informe});
      if(telContratista){
        sendBuilderbotMessage(telContratista, msgAprobado());
      } else {
        console.warn('Tel√©fono contratista inv√°lido/no disponible');
      }
      Swal.fire({icon:'success',title:'Cuenta Aprobada',timer:1800,showConfirmButton:false});
      await cargarCuentasPendientes();
      showView('view-revision');
    }catch(e){
      Swal.fire({icon:'error',title:'Error',text:e.message});
    }
  } else if(rs.isDenied){
    try{
      await apiPost('devolverCuenta',{documento,informe,observaciones:observ});
      if(supervisorGrupoId){
        // Se env√≠a tal cual como "number" porque el backend acepta grupo tambi√©n
        sendBuilderbotMessage(supervisorGrupoId, msgDevueltaSupervisor());
      } else {
        console.warn('ID grupo supervisor vac√≠o');
      }
      if(telContratista){
        sendBuilderbotMessage(telContratista, msgDevueltaContratista());
      }
      Swal.fire({icon:'success',title:'Cuenta Devuelta',timer:1800,showConfirmButton:false});
      await cargarCuentasPendientes();
      showView('view-revision');
    }catch(e){
      Swal.fire({icon:'error',title:'Error',text:e.message});
    }
  }
});
}

  function initRevisionToggleSections(){
  const defs = [
    ['btn-toggle-contrato','sec-contrato','Ver Informaci√≥n del Contrato','Ocultar Informaci√≥n del Contrato'],
    ['btn-toggle-informe','sec-informe','Ver Relaci√≥n de Informe y Pago','Ocultar Relaci√≥n de Informe y Pago'],
    ['btn-toggle-planilla','sec-planilla','Ver Relaci√≥n de Planilla','Ocultar Relaci√≥n de Planilla'],
    ['btn-toggle-planilla2','sec-planilla2','Ver Relaci√≥n de Planilla Anexa','Ocultar Relaci√≥n de Planilla Anexa'],
    ['btn-toggle-actividades','sec-actividades','Ver Relaci√≥n de Actividades','Ocultar Relaci√≥n de Actividades']
  ];
  defs.forEach(([btnId,secId,showTxt,hideTxt])=>{
    const btn = document.getElementById(btnId);
    const sec = document.getElementById(secId);
    if(!btn || !sec) return;
    if(btn.dataset.bound) return;  // evita duplicados
    btn.dataset.bound = '1';
    btn.addEventListener('click',()=>{
      const visible = !sec.classList.contains('hidden');
      if(visible){
        sec.classList.add('hidden');
        btn.textContent = showTxt;
      }else{
        sec.classList.remove('hidden');
        btn.textContent = hideTxt;
      }
    });
  });
}
initRevisionToggleSections();
  
  
/* ================== REQUERIMIENTOS ================== */
let REQ_DATA=[];
async function cargarRequerimientosBase(){
  try{
    const list=await apiGet('listContratistas');
    REQ_DATA=Array.isArray(list)?list:[];
    pintarRequerimientos(REQ_DATA);
    actualizarResumenReq(REQ_DATA);
  }catch(e){
    REQ_DATA=[];
    pintarRequerimientos(REQ_DATA);
    actualizarResumenReq(REQ_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function actualizarResumenReq(list){
  const box=document.getElementById('req-count');
  if(!box) return;
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent=String(list.length);
  box.style.display='inline-block';
}
function pintarRequerimientos(list){
  const wrap=document.getElementById('req-list');
  wrap.innerHTML='';
  if(!list.length){
    wrap.innerHTML='<p class="muted center">No hay contratistas.</p>';
    return;
  }
  for(const c of list){
    const div=document.createElement('div');
    div.className='item-card';

    const header=document.createElement('div');
    header.className='item-header';

    const title=document.createElement('p');
    title.className='item-title';
    title.textContent='NOMBRE: '+(c.nombre||'');

    header.appendChild(title);
    div.appendChild(header);

    const btnRow=document.createElement('div');
    btnRow.className='btn-row';

    const btnRedact=document.createElement('button');
btnRedact.textContent='REDACTAR';
btnRedact.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  abrirModalRequerimiento(c);
});

    btnRow.appendChild(btnRedact);
    div.appendChild(btnRow);

    wrap.appendChild(div);
  }
}
document.getElementById('req-filter').addEventListener('input',()=>{
  const q=document.getElementById('req-filter').value.trim().toLowerCase();
  const filtered=REQ_DATA.filter(c=>{
    return [c.nombre,c.documento,c.secretaria,c.supervisor,c.telefono]
      .some(v=>String(v||'').toLowerCase().includes(q));
  });
  pintarRequerimientos(filtered);
  actualizarResumenReq(filtered);
});
document.getElementById('req-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== MODAL REQUERIMIENTO ================== */
let MODAL_TARGET=null;
function abrirModalRequerimiento(c){
  MODAL_TARGET=c;
  document.getElementById('modal-req-text').value='';
  document.getElementById('modal-requerimiento').classList.remove('hidden');
}
document.getElementById('modal-req-cancelar').addEventListener('click',()=>{
  document.getElementById('modal-requerimiento').classList.add('hidden');
});
document.getElementById('modal-req-enviar').addEventListener('click',()=>{
  const txt=(document.getElementById('modal-req-text').value||'').trim();
  if(!MODAL_TARGET){ return; }
  if(!txt){
    Swal.fire({icon:'warning',title:'Texto requerido'}); return;
  }
  // Normaliza el tel√©fono (agrega 57 si viene a 10 d√≠gitos y valida)
const telefonoNormalizado = normalizeContratistaNumber(MODAL_TARGET.telefono);
const nombre = (MODAL_TARGET.nombre || '').trim();

// Mensaje EXACTO solicitado
const mensaje = 
  'Estimado(a) *' + nombre + '*\n\n' +
  'Tenemos el siguiente requerimiento:\n\n*' + txt + '*\n\n' +
  'Cordialmente,\n\n*Equipo de Contrataci√≥n*\n> Alcald√≠a de Flandes';

if (telefonoNormalizado){
  sendBuilderbotMessage(telefonoNormalizado, mensaje);
} else {
  // Si el n√∫mero no es v√°lido, avisa al usuario
  Swal.fire({ icon:'warning', title:'Tel√©fono inv√°lido', text:'No se pudo enviar el requerimiento por WhatsApp.' });
}
  document.getElementById('modal-requerimiento').classList.add('hidden');
  Swal.fire({icon:'success',title:'Requerimiento enviado',timer:1800,showConfirmButton:false});
});

/* ================== COMUNICADOS ================== */
document.getElementById('comunicado-enviar').addEventListener('click',async()=>{
  const txt=(document.getElementById('comunicado-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarComunicado',{
      profesional: currentUser?.profesional || '',
      noticia: txt
    });
    Swal.fire({icon:'success',title:'COMUNICADO CARGADO CON √âXITO',timer:4000,showConfirmButton:false});
    document.getElementById('comunicado-text').value='';
    renderInicio();
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('comunicado-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== SOPORTE ================== */
document.getElementById('soporte-enviar').addEventListener('click',async()=>{
  const txt=(document.getElementById('soporte-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarSoporte',{
      profesional: currentUser?.profesional || '',
      soporte: txt,
      celular: currentUser?.celular || ''
    });
    Swal.fire({icon:'success',title:'SOLICITUD CARGADA CON √âXITO',timer:4000,showConfirmButton:false});
    document.getElementById('soporte-text').value='';
    renderInicio();
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('soporte-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== PWA ================== */
let deferredPrompt = null;
function isStandalone(){
  const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const dmInstalled  = window.matchMedia('(display-mode: installed)').matches;
  const iosStandalone = (window.navigator.standalone === true);
  return dmStandalone || dmInstalled || iosStandalone;
}
function isIOS(){ return /(iphone|ipad|ipod)/i.test(navigator.userAgent || ''); }
function isMarkedInstalled(){ try{ return localStorage.getItem('pwaInstalledFlagSupervision') === '1'; }catch(_){ return false; } }
function markInstalled(){ try{ localStorage.setItem('pwaInstalledFlagSupervision', '1'); }catch(_){ } }
function clearInstalledMark(){ try{ localStorage.removeItem('pwaInstalledFlagSupervision'); }catch(_){ } }
async function detectInstalled(){
  if (isStandalone()) return true;
  if (typeof navigator.getInstalledRelatedApps === 'function'){
    try{
      const apps = await navigator.getInstalledRelatedApps();
      const found = apps.some(a => a.platform === 'webapp' && typeof a.url === 'string' && /manifest\.webmanifest$/.test(a.url));
      if (found){ markInstalled(); return true; } else { clearInstalledMark(); }
    }catch(_){}
  }
  return isMarkedInstalled();
}
function updateInstallButtonsVisibility(){
  const btn1 = document.getElementById('btn-instalar');
  const canPrompt = !!deferredPrompt;
  const installed = isMarkedInstalled() || isStandalone();
  const shouldShow = !installed && (canPrompt || isIOS());
  if(btn1) btn1.style.display = shouldShow ? '' : 'none';
}
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; updateInstallButtonsVisibility(); });
window.addEventListener('appinstalled', ()=>{ markInstalled(); deferredPrompt = null; updateInstallButtonsVisibility(); });
document.getElementById('btn-instalar').addEventListener('click', async ()=>{
  if(isIOS()){
    // Instrucciones iOS (igual que referencia.md)
    return Swal.fire({
      icon:'info',
      title:'Instalar en iPhone/iPad',
      html:'1) Toca Compartir (cuadro con flecha).<br>2) Elige "Agregar a pantalla de inicio".<br>3) Confirma "Agregar".'
    });
  }
  if(!deferredPrompt){
    return Swal.fire({ icon:'info', title:'Instalaci√≥n no disponible todav√≠a' });
  }
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  deferredPrompt = null;

  if (choice.outcome === 'accepted'){
    markInstalled();

    // ALERTA IGUAL A referencia.md
    Swal.fire({
      icon: 'success',
      title: '¬°App instal√°ndose!',
      html: 'Debes esperar 1 minuto.<br><br>Al terminar este tiempo, refresca la p√°gina o busca el icono de la aplicaci√≥n en la pantalla de tu dispositivo.',
      timer: 8000,
      showConfirmButton: false
    });
  } else {
    Swal.fire({ icon:'info', title:'Instalaci√≥n cancelada' });
  }
  updateInstallButtonsVisibility();
});

async function initPWAVista(){
  const installed = await detectInstalled();
  if (installed){ showView('view-login'); } else { showView('view-instalar'); updateInstallButtonsVisibility(); }
}
if ('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }
window.addEventListener('load', initPWAVista);
  
// Helper para IDs con prefijo "add-"
function $id(base) {
  return document.getElementById('add-' + base) || document.getElementById(base);
}

/* ========= FECHA CONTRATO (ruleta) ========= */
(function initPickerFecha() {
  const dias = document.getElementById('pickerDia');
  const meses = document.getElementById('pickerMes');
  if (!dias || !meses) return;

  for (let d = 1; d <= 31; d++) {
    const opt = document.createElement('option');
    opt.value = String(d).padStart(2, '0');
    opt.textContent = String(d).padStart(2, '0');
    dias.appendChild(opt);
  }

  const mesesNombres = [
    'Enero','Febrero','Marzo','Abril','Mayo','Junio',
    'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'
  ];
  for (let i = 0; i < 12; i++) {
    const opt = document.createElement('option');
    opt.value = String(i + 1).padStart(2, '0');
    opt.textContent = mesesNombres[i];
    meses.appendChild(opt);
  }
})();

function abrirPickerFecha() {
  const modal = document.getElementById('fechaModal');
  if (modal) modal.style.display = 'flex';
}
function cancelarPickerFecha() {
  const modal = document.getElementById('fechaModal');
  if (modal) modal.style.display = 'none';
  const fc = $id('fechaContrato'); if (fc) fc.value = '';
  const d  = $id('diaContrato');   if (d)  d.value = '';
  const m  = $id('mesContrato');   if (m)  m.value = '';
}
function confirmarPickerFecha() {
  const modal = document.getElementById('fechaModal');
  const dSel = (document.getElementById('pickerDia')?.value) || '01';
  const mSel = (document.getElementById('pickerMes')?.value) || '01';
  const anio = '2026';

  const fc = $id('fechaContrato'); if (fc) fc.value = `${dSel}/${mSel}/${anio}`;
  const d  = $id('diaContrato');   if (d)  d.value = dSel;

  const mesesNombres = [
    'Enero','Febrero','Marzo','Abril','Mayo','Junio',
    'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'
  ];
  const idx = Math.max(1, Math.min(12, parseInt(mSel, 10))) - 1;
  const m   = $id('mesContrato');   if (m)  m.value = mesesNombres[idx];

  if (modal) modal.style.display = 'none';
}

(function bindFechaContratoChange(){
  const fc = $id('fechaContrato');
  if (!fc) return;
  fc.addEventListener('change', function () {
    actualizarCamposFecha(this.value, 'diaContrato', 'mesContrato');
  });
})();
function actualizarCamposFecha(fechaISO, idDiaBase, idMesBase) {
  if (!fechaISO) {
    const d = $id(idDiaBase); if (d) d.value = '';
    const m = $id(idMesBase); if (m) m.value = '';
    return;
  }
  const dObj = new Date(fechaISO + 'T00:00:00');
  if (isNaN(dObj)) {
    const d = $id(idDiaBase); if (d) d.value = '';
    const m = $id(idMesBase); if (m) m.value = '';
    return;
  }
  const dd = String(dObj.getUTCDate()).padStart(2, '0');
  const mm = dObj.getUTCMonth();
  const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  const d = $id(idDiaBase); if (d) d.value = dd;
  const m = $id(idMesBase); if (m) m.value = meses[mm];
}

/* ========= VALOR -> VALOR TEXTO (MAY√öSCULA) ========= */
(function initValorTexto(){
  const valor = $id('valor');
  const valorTexto = $id('valorTexto');
  if (!valor || !valorTexto) return;

  valor.addEventListener('input', () => {
    let raw = (valor.value || '').replace(/\D/g, '');
    valor.value = raw;
    const len = raw.length;

    valorTexto.style.border = '';
    if ((len >= 1 && len <= 5) || len > 8) {
      valorTexto.style.border = '2px solid red';
    } else if (len === 8) {
      valorTexto.style.border = '2px solid green';
    }

    const n = parseInt(raw || '0', 10);
    const texto = convertirNumeroATexto(n); // ya retorna en may√∫sculas
    valorTexto.value = texto ? (texto + ' PESOS M/CTE') : '';
    // Garantizar may√∫sculas siempre:
    valorTexto.value = (valorTexto.value || '').toUpperCase();
  });
})();

/* ========= CDP (borde verde si empieza por 2026) ========= */
(function initCDP(){
  const cdp = $id('cdp');
  if (!cdp) return;
  cdp.addEventListener('input', () => {
    let raw = (cdp.value || '').replace(/\D/g, '').slice(0, 10);
    cdp.value = raw;
    cdp.style.border = '';
    if (raw.length === 10 && raw.startsWith('2026')) {
      cdp.style.border = '2px solid green';
    }
  });
})();

/* ========= Conversor n√∫mero->texto (MAY√öSCULAS) ========= */
function convertirNumeroATexto(numero) {
  const unidades = ["", "UN", "DOS", "TRES", "CUATRO", "CINCO", "SEIS", "SIETE", "OCHO", "NUEVE"];
  const decenas  = ["", "DIEZ", "VEINTE", "TREINTA", "CUARENTA", "CINCUENTA", "SESENTA", "SETENTA", "OCHENTA", "NOVENTA"];
  const centenas = ["", "CIENTO", "DOSCIENTOS", "TRESCIENTOS", "CUATROCIENTOS", "QUINIENTOS", "SEISCIENTOS", "SETECIENTOS", "OCHOCIENTOS", "NOVECIENTOS"];
  const especiales = ["DIEZ", "ONCE", "DOCE", "TRECE", "CATORCE", "QUINCE", "DIECISEIS", "DIECISIETE", "DIECIOCHO", "DIECINUEVE"];

  function convCentenas(n) {
    if (n === 100) return "CIEN";
    if (n > 100) return (centenas[Math.floor(n/100)] + " " + convDecenas(n%100)).trim();
    return convDecenas(n);
  }
  function convDecenas(n) {
    if (n < 10) return unidades[n];
    if (n < 20) return especiales[n-10];
    if (n === 20) return "VEINTE";
    if (n < 30) return "VEINTI" + unidades[n%10];
    return decenas[Math.floor(n/10)] + (n%10 ? " Y " + unidades[n%10] : "");
  }
  function convMiles(n) {
    if (n < 1000) return convCentenas(n);
    if (n < 1000000) {
      const miles = Math.floor(n/1000), resto = n%1000;
      if (miles === 1) return ("MIL " + (resto ? convCentenas(resto) : "")).trim();
      return (convCentenas(miles) + " MIL " + (resto ? convCentenas(resto) : "")).trim();
    }
    const millones = Math.floor(n/1000000), resto = n%1000000;
    if (millones === 1) return ("UN MILL√ìN " + (resto ? convMiles(resto) : "DE")).trim();
    return (convCentenas(millones) + " MILLONES " + (resto ? convMiles(resto) : "DE")).trim();
  }
  let t = convMiles(parseInt(numero || 0, 10));
  if (t.endsWith(" UNO")) t = t.slice(0, -4) + " UN";
  return t;
}

  // Autogrow del textarea de Obligaciones
(function autoGrowObligaciones(){
  const ta = document.getElementById('add-obligaciones');
  if (!ta) return;
  const resize = ()=>{
    ta.style.height = 'auto';
    ta.style.height = (ta.scrollHeight + 4) + 'px';
  };
  ['input','change'].forEach(ev => ta.addEventListener(ev, resize));
  // Primer ajuste si trae texto pegado
  resize();
})();

/* ================== FIN ================== */
</script>
</body>
</html>
